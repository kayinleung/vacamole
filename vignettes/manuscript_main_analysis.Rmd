---
title: "Impact of vaccinating adolescents and children on COVID-19 disease outcomes"
subtitle: "Main analysis"
author: "Kylie Ainslie"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quick start guide for vacamole}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview
This vignette provides detailed code to reproduce the main analysis the paper XX cite XX. Briefly, we quantify the benefits of extending COVID-19 vaccination beyond adults by simulating the model (described in the Quick Start Guide) forward in time under different vaccination strategies. Specifically, we compare daily cases, hospital admissions, and intensive care (IC) admissions for vaccination in adults only, those 12 years and above, and those 5 years and above. All of the functions used here are well documented and have many tunable arguments, and we therefore encourage users to refer to the helps files. 

This vignette demonstrates only how to reproduce the model fits and forward simulations. Code to reproduce figures from the main text in the accompanying paper can be found in the [`inst/extdata/scripts/manuscript`](https://github.com/kylieainslie/vacamole/tree/master/inst/extdata/scripts/manuscripts) folder of the package.

## Installation and requirements
`vacamole` may be installed from github using the `devtools` package. There are a number of additional packages that we need for this analysis.
```{r message=FALSE, warning=FALSE, r,eval=TRUE}
# Required to run serosolver
devtools::install_github("kylieainslie/vacamole")
library(vacamole)
## Required for this analysis
library(deSolve)
library(reshape2)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(readxl)
library(rARPACK)
library(readr)
library(lubridate)
```

## Preparing the data and model inputs
First we need to load the vaccination schedules for the different vaccination strategies: adults only (18+), extension to adolescents (12+), and extension to adolescents and children (5+). These files are located in the [`inst/extdata/data/vaccination_scenarios`](https://github.com/kylieainslie/vacamole/tree/master/inst/extdata/data/vaccination_scenarios) folder of the package. Each file includes a column for vaccine product and dose for each age group (see [`Quick Start Guide`](https://github.com/kylieainslie/vacamole/tree/master/vignettes)). Rows indicate the proportion of that age group who received that dose and product on that day.
```{r read_vac_sched, echo=TRUE, eval=FALSE}
basis_5plus <- read_csv("../inst/extdata/data/vaccination_scenarios/vac_schedule_5plus.csv") %>%
  select(-starts_with("X"))

basis_12plus <- read_csv("../inst/extdata/data/vaccination_scenarios/vac_schedule_12plus.csv") %>%
  select(-starts_with("X"))

basis_18plus <- read_csv("../inst/extdata/data/vaccination_scenarios/Cvac_schedule_18plus.csv") %>%
  select(-starts_with("X"))
```

Next, the vaccination schedules needs to be converted before input into the model. The vaccination schedule data frame is converted into a list with weighted averages of the following quantities: vaccination rate, vaccine effectiveness, and delay to protection based on the number of people in the population who receive each dose and type of vaccine at each time point. The model is designed to incorporate a single vaccine product with a 2-dose regimen. However, since there is more than one vaccine product currently licensed for use against COVID-19 in The Netherlands (the vaccines made by Pfizer/BioNTech, Moderna, AstraZeneca, and Janssen), we incorporate different vaccine products by taking the daily weighted average of the number of people with each vaccine product (and dose), the corresponding delay to protection of each vaccine product, and the vaccine effectiveness against each outcome (Table S1). Janssen is incorporated by using zero for the number of second doses at all time points. To convert the vaccine schedules, we use the `convert_vac_schedule()` function which needs arguments
```{r convert_vac_sched, echo=TRUE, eval=FALSE}
converted_5plus <- convert_vac_schedule(vac_schedule = basis_5plus,
  ve = ve_delta, hosp_multiplier = h_multiplier_delta, ve_trans = ve_trans_delta,
  delay = delays, add_extra_dates = TRUE, extra_end_date = "2022-03-31"
)

converted_12plus <- convert_vac_schedule(vac_schedule = basis_12plus,
  ve = ve_delta, hosp_multiplier = h_multiplier_delta, ve_trans = ve_trans_delta,
  delay = delays, add_extra_dates = TRUE, extra_end_date = "2022-03-31"
)

converted_18plus <- convert_vac_schedule(vac_schedule = basis_18plus,
  ve = ve_delta, hosp_multiplier = h_multiplier_delta, ve_trans = ve_trans_delta,
  delay = delays, add_extra_dates = TRUE, extra_end_date = "2022-03-31"
)
```

Read in model fits to use as initial conditions.
```{r read_in_model_fits, echo=TRUE, eval=FALSE}
file_path <- "inst/extdata/results/model_fits/"
date_of_fit <- "2021-10-01" # this specifies the suffix on the model fit file

output_from_model_fit <- readRDS(paste0(file_path,"output_from_fits_", date_of_fit, ".rds"))
# get the number of individuals in each state on the last day of model fit (22 June 2021)
init_cond_22june2021 <- unlist(lapply(unname(output_from_model_fit$`end_date_2021-06-22`), tail,1))

# read in values of 
beta_mles <- data.frame(beta = readRDS(paste0(file_path,"mles_from_fits_", date_of_fit,".rds"))) %>%
  mutate(end_date = names(output_from_model_fit))
beta_draws <- readRDS(paste0(file_path,"beta_draws_from_fits_", date_of_fit, ".rds"))

index <- which(beta_mles$end_date == "end_date_2021-06-22")

# create list of transmission matrices
# note: these are loaded from the model_run_helper.R script
cm <- list(baseline_2017 = baseline_2017,
           april_2020 = april_2020,
           june_2020 = june_2020,
           september_2020 = september_2020,
           february_2021 = february_2021,
           june_2021 = june_2021)

```

For the beginning of the forward simulations we use the transmission rate from the last time window of the model fit. However, once non-pharmaceutical interventions (NPIs) are relaxed we need a transmission rate that was not estimated during a time period in which NPIs were in use. Thus, for forward simulations, we use the transmission rate that corresponds to the basic reproduction number of the Delta variant (R_0 = 4.6). To incorporate uncertainty, we draw random samples of the reproduction number from a normal distribution with mean 4.6 and standard deviation equal to the square root of the variance from the model fits of the last time window before the forward simulations.
```{r betas, echo=TRUE, eval=FALSE}
my_sd <- sqrt(0.0000945)  # sqrt(var) of Rt from fits to last time window
S_diag <- diag(init[c(2:10)]) # diagonal matrix of susceptibles
rho <- as.numeric(eigs(S_diag %*% params$c_normal, 1)$values) # parameter to convert Rt to beta

# R draws
rt <- rnorm(n = 200, mean = 4.6, sd = my_sd)  # beta = 0.0003934816 * 2 = 0.0007869632

# convert to beta
betas <- c(0.0007869632, (rt_for_delta_period / rho) * params$gamma)
```

Run model for the different beta and transmission draws using `forward_sim_wrap_func()`. 
```{r run, echo=TRUE, eval=FALSE}
# -------------------------------------------------------------------
# run models --------------------------------------------------------
# -------------------------------------------------------------------
todays_date <- Sys.Date()

# 5+
forward_sim_func_wrap(start_date = "2021-06-22",
                      end_date = "2021-03-31",
                      init_cond = init_cond_22june2021,
                      beta_m = beta_mles[index,1],
                      vac_inputs = converted_5plus1,
                      beta_c = betas,
                      beta_d = beta_draws[[index]][,1],
                      t_normal = NULL,
                      contact_matrices = cm,
                      tag = paste0("results_5plus_",todays_date))
# 12+
forward_sim_func_wrap(start_date = "2021-06-22",
                      end_date = "2021-03-31",
                      init_cond = init_cond_22june2021,
                      beta_m = beta_mles[index,1],
                      vac_inputs = converted_12plus,
                      beta_c = betas,
                      beta_d = beta_draws[[index]][,1],
                      t_normal = NULL,
                      contact_matrices = cm,
                      tag = paste0("results_12plus_",todays_date))

# 18+ 
forward_sim_func_wrap(start_date = "2021-06-22",
                      end_date = "2021-03-31",
                      init_cond = init_cond_22june2021,
                      beta_m = beta_mles[index,1],
                      vac_inputs = converted_18plus,
                      beta_c = betas,
                      beta_d = beta_draws[[index]][,1],
                      t_normal = NULL,
                      contact_matrices = cm,
                      tag = paste0("results_18plus_",todays_date))
```

